<?php
include 'db_connect.php';
include 'header.php';

// Kawalan Akses: Benarkan Admin, Markas, dan Superadmin
$allowed_roles = ['admin', 'markas', 'superadmin'];
if (!isset($_SESSION['role']) || !in_array($_SESSION['role'], $allowed_roles)) {
    header("Location: Login.php");
    exit();
}

$current_role = $_SESSION['role'];
$current_markas = $_SESSION['markas_id'] ?? '';

// Proses Pengaktifan Akaun
if (isset($_GET['activate_id'])) {
    $uid = mysqli_real_escape_string($conn, $_GET['activate_id']);
    $conn->query("UPDATE users SET is_active = 1 WHERE user_id = '$uid'");
    echo "<script>alert('Akaun berjaya diaktifkan!'); window.location='verify_users.php';</script>";
}

// Logik Query: Tapis mengikut peranan
if ($current_role === 'markas') {
    $sql = "SELECT * FROM users WHERE role = 'user' AND is_active = 0 AND markas_id = '$current_markas'";
} else {
    $sql = "SELECT * FROM users WHERE is_active = 0 AND role != 'superadmin'";
}
$result = $conn->query($sql);
?>

<div style="max-width: 1100px; margin: 40px auto; padding: 30px; background: white; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border-top: 5px solid #28a745;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <h2 style="color: #28a745; margin: 0;"><i class="fas fa-user-check"></i> Pengesahan Akaun (Verify User)</h2>
        <a href="dashboard_kagat.php" class="btn-pill btn-green" style="background:#28a745; color:white; text-decoration:none; padding:10px 20px; border-radius:50px; font-size:12px;">
            <i class="fas fa-arrow-left"></i> KEMBALI
        </a>
    </div>

    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background: #f8f9fa; text-align: left;">
                <th style="padding: 15px; border-bottom: 2px solid #eee;">Nama Penuh</th>
                <th style="padding: 15px; border-bottom: 2px solid #eee;">No. Tentera</th>
                <th style="padding: 15px; border-bottom: 2px solid #eee;">Markas</th>
                <th style="padding: 15px; border-bottom: 2px solid #eee; text-align: center;">Tindakan</th>
            </tr>
        </thead>
        <tbody>
            <?php if ($result->num_rows > 0): ?>
                <?php while($row = $result->fetch_assoc()): ?>
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 15px; font-weight: bold;"><?php echo htmlspecialchars($row['full_name']); ?></td>
                    <td style="padding: 15px;"><?php echo htmlspecialchars($row['no_kp_tentera']); ?></td>
                    <td style="padding: 15px;"><span style="background:#eee; padding:4px 10px; border-radius:4px; font-size:11px;"><?php echo htmlspecialchars($row['markas_id']); ?></span></td>
                    <td style="padding: 15px; text-align: center;">
                        <a href="verify_users.php?activate_id=<?php echo $row['user_id']; ?>" 
                           onclick="return confirm('Sahkan akaun ini?')"
                           style="background: #28a745; color: white; padding: 8px 20px; border-radius: 50px; text-decoration: none; font-size: 12px; font-weight: bold;">
                            AKTIFKAN
                        </a>
                    </td>
                </tr>
                <?php endwhile; ?>
            <?php else: ?>
                <tr><td colspan="4" style="padding: 40px; text-align: center; color: #999;">Tiada pengguna menunggu pengesahan.</td></tr>
            <?php endif; ?>
        </tbody>
    </table>
</div>

<?php include 'footer.php'; ?>